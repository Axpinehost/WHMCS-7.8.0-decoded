function initStripe(){var e=jQuery('input[name="paymentmethod"]'),t=jQuery("#frmCheckout"),i=jQuery(".frm-credit-card-input"),s=jQuery("#frmPayment"),n=jQuery("#frmCreditCardDetails");if(e.length&&!i.length){var r=jQuery("#newCardInfo");insertAndMountElementsDivAfterInput(r),elementsDiv=jQuery("#stripeElements");var a=jQuery('input[name="ccinfo"]'),d=jQuery('input[name="ccinfo"]:checked'),l=jQuery('input[name="paymentmethod"]:checked').val(),o=jQuery("#existingCardInfo");"undefined"==typeof l&&(l=jQuery('input[name="paymentmethod"]').val()),enablePaymentRequestButton(),"stripe"===l&&(hide_cc_fields(),enable_stripe(),"new"!==d.val()&&(get_existing_token(d.val()),elementsDiv.hide(),t.off("submit",validateStripe),t.off("submit",validateChangeCard),o.hide(),t.on("submit",processExisting))),e.on("ifChecked",function(){if(l=jQuery(this).val(),"stripe"===l){var e=jQuery('input[name="ccinfo"]:checked').val();hide_cc_fields(),enable_stripe(),"new"!==e?(get_existing_token(e),elementsDiv.hide(),t.off("submit",validateStripe),t.off("submit",validateChangeCard),t.on("submit",processExisting)):(elementsDiv.show(),t.off("submit",processExisting),"000"===amount?(t.off("submit",validateStripe),t.on("submit",validateChangeCard)):(t.on("submit",validateStripe),t.off("submit",validateChangeCard)))}else disable_stripe()}),a.on("ifChecked",function(){t.off("submit",validateStripe),l=jQuery('input[name="paymentmethod"]:checked').val(),"stripe"===l&&(hide_cc_fields(),"new"===jQuery(this).val()?enable_stripe():(get_existing_token(jQuery(this).val()),elementsDiv.hide()))})}else if(i.length)"stripe"===jQuery('input[name="type"]:checked').data("gateway")&&(insertAndMountElementsDivBeforeInput(i.find("div.cc-details")),elementsDiv=jQuery("#stripeElements"),hide_cc_fields(),elementsDiv.hide().removeClass("hidden").show(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),i.on("submit",addNewCardClientSide)),jQuery('input[name="type"]').on("ifChecked",function(){"stripe"===jQuery(this).data("gateway")?(insertAndMountElementsDivBeforeInput(i.find("div.cc-details")),elementsDiv=jQuery("#stripeElements"),hide_cc_fields(),elementsDiv.hide().removeClass("hidden").show(),i.off("submit",addNewCardClientSide),i.on("submit",addNewCardClientSide),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener)):(disable_stripe(),i.find(".cc-details").show())});else if(s.length)insertAndMountElementsDivBeforeInput(s.find("#billingAddressChoice")),s.find("#inputCardCvv").closest("div.form-group").remove(),s.off("submit",validateCreditCardInput),"new"===jQuery('input[name="ccinfo"]:checked').val()?enable_payment_stripe():(get_existing_token(jQuery('input[name="ccinfo"]:checked').val()),s.on("submit",processExisting)),jQuery('input[name="ccinfo"]').on("ifChecked",function(){"new"===jQuery(this).val()?enable_payment_stripe():(get_existing_token(jQuery(this).val()),jQuery("#stripeElements").hide(),s.off("submit",validateStripe),s.on("submit",processExisting),card.hasRegisteredListener("change")&&card.removeEventListener("change",cardListener))}),enablePaymentRequestButton();else if(n.length)if(n.find("#cctype").closest("tr").hide().remove(),n.find("#inputCardNumber").closest("div").html('<div id="elementCardNumber" class="form-control"></div>'),n.find("#inputCardExpiry").closest("div").html('<div id="elementCardExpiry" class="form-control"></div>'),n.find("#cardcvv").closest("div").html('<div id="elementCardCvc" class="form-control"></div>'),card.mount("#elementCardNumber"),cardExpiryElements.mount("#elementCardExpiry"),cardCvcElements.mount("#elementCardCvc"),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),elementsDiv=jQuery("#elementCardNumber"),jQuery("#containerStorageInputControl")){var c=jQuery("#modalAjaxFooter"),m=c.find("#btnSave");m.removeAttr("name"),m.off(),m.on("click",validateChangeCard),modalInput=!0}else n.find("#btnSaveChanges").removeAttr("name"),n.on("submit",validateChangeCard)}function validateStripe(e){var t=jQuery('input[name="paymentmethod"]:checked'),i=elementsDiv.closest("form"),s=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();return!(!t.length||"stripe"===t.val())||(e.preventDefault(),i.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),stripe.createPaymentMethod("card",card).then(function(e){if(e.error){var t=e.error.message;t&&(s.html(t),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToError())}else WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:i.serialize()+"&payment_method_id="+e.paymentMethod.id,success:function(e){e.success?stripeResponseHandler(e.token):stripe.handleCardPayment(e.token,card).then(function(e){if(e.error){var t=e.error.message;t&&(s.html(t),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToError())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToError()},fail:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToError()}})}),!1)}function processExisting(e){var t=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();t.find(".gateway-errors").html("").addClass("hidden"),e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:t.serialize()+"&payment_method_id="+existingToken,success:function(e){e.success?stripeResponseHandler(e.token):stripe.handleCardPayment(e.token).then(function(e){if(e.error){var t=e.error.message;t&&(i.html(t),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError())}else stripeResponseHandler(e.paymentIntent.id)})},fail:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError()}})}function stripeResponseHandler(e){var t=elementsDiv.closest("form");t.find(".gateway-errors,.assisted-cc-input-feedback").html("").addClass("hidden"),t.append(jQuery('<input type="hidden" name="remoteStorageToken">').val(e)),t.find('button[type="submit"],input[type="submit"]').find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-spinner fa-spin"),modalInput||elementsDiv.hide(),t.off("submit",validateStripe),t.off("submit",validateChangeCard),t.off("submit",addNewCardClientSide),t.off("submit",processExisting),t.append('<input type="submit" id="hiddenSubmit" name="submit" value="Save Changes" style="display:none;">');var i=jQuery("#hiddenSubmit");if(modalInput){var s=jQuery("#modalAjaxFooter"),i=s.find("#btnSave");i.removeClass("disabled"),jQuery("#modalAjax .loader").fadeOut(),i.off("click",validateChangeCard),i.on("click",submitIdAjaxModalClickEvent)}i.click()}function hide_cc_fields(){var e=elementsDiv.closest("form"),t=jQuery("#newCardInfo,.cc-details,#existingCardInfo");t.is(":visible")&&t.slideUp("fast",function(){e.find("#cctype").removeAttr("name"),e.find("#inputCardCvvExisting").removeAttr("name"),e.find("#inputCardNumber").removeAttr("name"),e.find("#inputCardExpiry").removeAttr("name"),e.find("#inputCardCVV").removeAttr("name"),e.find("#inputCardCvvExisting").removeAttr("name")})}function enable_stripe(){var e=elementsDiv.closest("form");hide_cc_fields(),elementsDiv.hide().removeClass("hidden").show(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),"000"===amount?(e.off("submit",validateStripe),e.on("submit",addNewCardClientSide)):(e.on("submit",validateStripe),e.off("submit",addNewCardClientSide)),e.off("submit",processExisting)}function disable_stripe(){var e=elementsDiv.closest("form"),t=jQuery("#newCardInfo,.cc-details");e.find("#inputCardCvvExisting").attr("name","cccvvexisting"),e.find("#inputCardNumber").attr("name","ccnumber"),e.find("#inputCardExpiry").attr("name","ccexpirydate"),e.find("#inputCardCVV").attr("name","cccvv"),e.find("#inputCardCvvExisting").attr("name","cccvvexisting"),e.find("#cctype").attr("name","cctype"),elementsDiv.hide("fast",function(){var e=jQuery('input[name="ccinfo"]:visible').first();"new"===e.val()?t.show():e.click()}),e.off("submit",validateStripe),e.off("submit",processExisting),e.off("submit",validateChangeCard),card.hasRegisteredListener("change")&&card.removeEventListener("change",cardListener),cardExpiryElements.hasRegisteredListener("change")&&cardExpiryElements.removeEventListener("change",cardListener),cardCvcElements.hasRegisteredListener("change")&&cardCvcElements.removeEventListener("change",cardListener)}function enable_payment_stripe(){var e=elementsDiv.closest("form");e.find("#inputCardNumber").closest("div.form-group").remove(),e.find("#inputCardExpiry").closest("div.form-group").remove(),elementsDiv.hide().removeClass("hidden").show(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),e.off("submit",processExisting),e.on("submit",validateStripe)}function enablePaymentRequestButton(){if(paymentRequestButtonEnabled){var e=(elementsDiv.closest("form"),stripe.paymentRequest({country:"US",currency:paymentRequestCurrency.toLowerCase(),total:{label:paymentRequestDescription,amount:paymentRequestAmountDue},requestPayerName:!0,requestPayerEmail:!0})),t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),i=elements.create("paymentRequestButton",{paymentRequest:e});e.canMakePayment().then(function(e){e&&(e.applePay,0===jQuery("#paymentRequestButton").length&&elementsDiv.prepend('<div class="row"><div class="col-md-4 col-md-offset-4"><div id="paymentRequestButton"></div></div></div>'),i.mount("#paymentRequestButton"))}),e.on("paymentmethod",function(e){var i=e.paymentMethod.id,s=null,n=e,r=elementsDiv.closest("form");r.find(".gateway-errors,.assisted-cc-input-feedback").html("").addClass("hidden"),r.find('button[type="submit"],input[type="submit"]').addClass("disabled").prop("disabled",!0).find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-spinner fa-spin"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:r.serialize()+"&payment_method_id="+i,success:function(e){s=e.token,e.success?(n.complete("success"),stripeResponseHandler(e.token)):stripe.handleCardPayment(s).then(function(e){if(e.error){var i=e.error.message;i&&(t.html(i),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToError())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){t.html(e),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToError()},fail:function(e){t.html(e),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToError()}})})}}function scrollToError(){var e=elementsDiv.closest("form"),t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();e.find('button[type="submit"],input[type="submit"]').prop("disabled",!1).removeClass("disabled").find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-arrow-circle-right").find("span").toggleClass("hidden"),t.length&&jQuery("html, body").animate({scrollTop:t.offset().top-50},500)}function insertAndMountElementsDivAfterInput(e){if(elementsDiv=jQuery("#stripeElements"),!elementsDiv.length){e.after(stripe_cc_html(e));var t=jQuery("#stripeCvcWhere");t.length&&(jQuery("#cvvWhereLink").clone().appendTo(t),jQuery('[data-toggle="popover"]').popover({html:!0})),elementsDiv=jQuery("#stripeElements"),card.mount("#stripeCreditCard"),cardExpiryElements.mount("#stripeExpiryDate"),cardCvcElements.mount("#stripeCvc")}}function insertAndMountElementsDivBeforeInput(e){if(elementsDiv=jQuery("#stripeElements"),!elementsDiv.length){e.before(stripe_cc_html(e));var t=jQuery("#stripeCvcWhere");t.length&&(jQuery("#cvvWhereLink").clone().appendTo(t),jQuery('[data-toggle="popover"]').popover({html:!0})),elementsDiv=jQuery("#stripeElements"),card.mount("#stripeCreditCard"),cardExpiryElements.mount("#stripeExpiryDate"),cardCvcElements.mount("#stripeCvc")}}function stripe_cc_html(e){var t=e.closest("form")[0],i="";return"frmCheckout"===t.id?i='<div id="stripeElements" class="form-group hidden"><div class="stripe-cards-inputs col-md-8 col-md-offset-2"><div class="row"><div class="col-md-6"><label for="stripeCreditCard">'+lang.creditCardInput+'</label><div id="stripeCreditCard" class="form-control"></div><div id="stripeCardType"></div></div><div class="col-md-3"><label for="stripeExpiryDate">'+lang.creditCardExpiry+'</label><div id="stripeExpiryDate" class="form-control"></div></div><div class="col-md-3"><label for="stripeCvc">'+lang.creditCardCvc+'</label><div id="stripeCvc" class="form-control"></div></div></div></div></div><div class="clearfix"></div>':(elementsClass="",i='<div id="stripeElements" class="hidden"><div class="form-group cc-billing-address"><label for="stripeCreditCard" class="col-sm-4 control-label">'+lang.creditCardInput+'</label><div class="col-sm-7"><div id="stripeCreditCard" class="form-control" aria-describedby="cc-type"></div><div id="stripeCardType"></div></div><div class="col-sm-4"></div></div><div class="form-group cc-billing-address"><label for="stripeExpiryDate" class="col-sm-4 control-label">'+lang.creditCardExpiry+'</label><div class="col-sm-2"><div id="stripeExpiryDate" class="form-control"></div></div><div class="col-sm-6"></div></div><div class="form-group cc-billing-address"><label for="stripeCvc" class="col-sm-4 control-label">'+lang.creditCardCvc+'</label><div class="col-sm-2"><div id="stripeCvc" class="form-control"></div></div><div class="col-sm-4"><div id="stripeCvcWhere"></div></div></div></div></div><div class="clearfix"></div>'),i}function cardListener(e){var t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),i="";"undefined"!=typeof e.error?(i=e.error.message,i&&(t.html(i),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToError())):t.hide().addClass("hidden").html(""),"undefined"!=typeof e.brand}function addNewCardClientSide(e){var t=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/setup/intent"),data:t.serialize(),success:function(e){e.success&&stripe.handleCardSetup(e.setup_intent,card).then(function(e){e.error?(i.html(e.error),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError()):stripeResponseHandler(e.setupIntent.id)})},warning:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError()},fail:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError()}})}function validateChangeCard(e){var t=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();return e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),stripe.createPaymentMethod("card",card).then(function(e){if(e.error){var s=e.error.message;s&&(i.html(s),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError())}else{if(modalInput){var n=jQuery("#btnSave");n.addClass("disabled"),jQuery("#modalAjax .loader").show()}if("undefined"!=typeof WHMCS.utils)var r=WHMCS.utils.getRouteUrl("/stripe/payment/add");else var r=WHMCS.adminUtils.getAdminRouteUrl("/stripe/payment/admin/add");WHMCS.http.jqClient.jsonPost({url:r,data:t.serialize()+"&payment_method_id="+e.paymentMethod.id,success:function(e){e.success&&stripeResponseHandler(e.token)},warning:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError()},fail:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError()},always:function(){modalInput&&(n.removeClass("disabled"),jQuery("#modalAjax .loader").fadeOut())}})}}),!1}function get_existing_token(e){if("undefined"==typeof e){var t=jQuery('input[name="ccinfo"]:visible:first');if(t.iCheck("check"),e=t.val(),"new"===e)return}var i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/get"),data:"paymethod_id="+e+"&token="+csrfToken,success:function(e){existingToken=e.token},warning:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError(),reset_input_to_new()},fail:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToError(),reset_input_to_new()}})}function reset_input_to_new(){jQuery('input[name="ccinfo"][value="new"]').iCheck("check"),jQuery("#existingCardInfo").is(":visible")&&jQuery("#existingCardInfo").hide(),setTimeout(function(){jQuery(".gateway-errors,.assisted-cc-input-feedback").hide().addClass("hidden")},4e3)}var elementsDiv=null,modalInput=!1;